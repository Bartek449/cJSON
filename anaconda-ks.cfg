# Generated by Anaconda 42.27.12
# Generated by pykickstart v3.62 #version=DEVEL


url --mirrorlist=http://mirrors.fedoraproject.org/mirrorlist?repo=fedora-42&arch=x86_64
repo --name=update --mirrorlist=http://mirrors.fedoraproject.org/mirrorlist?repo=updates-released-f42&arch=x86_64


#Keyboard layouts
keyboard --vckeymap=pl --xlayouts='pl' 
#System language
lang pl_PL.UTF-8

#Run the Setup Agent on first boot
firstboot --enable

#Generated using Blivet version 3.12.1
ignoredisk --only-use=sda


#Partition clearing information
clearpart --all --initlabel
autopart

#System timezone
timezone Europe/Warsaw --utc

#Root password
rootpw --allow-ssh root

user --groups=wheel --name=bartek --password=bartek

%packages
@core
@^server-product-environment
docker
wget 
curl
dnf
git
cmake
%end

# Skrypt postinstalacyjny
%post --interpreter=/usr/bin/bash
exec > /root/post-install.log 2>&1

echo "Tworzenie skryptu do uruchomienia Dockera i budowy kontenera..."

# 1) Skrypt w docelowym systemie:
cat << 'EOF' > /mnt/sysimage/usr/local/bin/start-docker-job.sh
#!/bin/bash
exec >> /var/log/docker-job.log 2>&1
echo "=== [start-docker-job.sh] ==="

# 1.a) Upewnij się, że demon Dockera jest aktywny
systemctl start docker
echo "Docker uruchomiony"

# 1.b) Klon i build
cd /root
if [ ! -d cJSON ]; then
  echo "Klonowanie repozytorium cJSON"
  git clone https://github.com/Bartek449/cJSON.git
fi

cd cJSON
echo "Budowanie obrazu lab02-build"
docker build -f Dockerfile.build -t lab02-build .

echo "Uruchamianie kontenera"
docker run --rm lab02-build

echo "=== [done] ==="
EOF

chmod +x /mnt/sysimage/usr/local/bin/start-docker-job.sh

echo "Tworzenie jednostki systemd..."

# 2) Jednostka systemd:
cat << 'EOF' > /mnt/sysimage/etc/systemd/system/docker-setup.service
[Unit]
Description=Jednorazowa konfiguracja Dockera i kontenera
After=network-online.target docker.service
Wants=network-online.target docker.service

[Service]
Type=oneshot
ExecStart=/usr/local/bin/start-docker-job.sh
RemainAfterExit=yes

[Install]
WantedBy=multi-user.target
EOF

# 3) Włączenie usług w chroot’cie:
chroot /mnt/sysimage systemctl enable docker.service
chroot /mnt/sysimage systemctl enable docker-setup.service

%end

reboot

reboot
