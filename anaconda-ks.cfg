# Generated by Anaconda 42.27.12
# Generated by pykickstart v3.62 #version=DEVEL

url --mirrorlist=http://mirrors.fedoraproject.org/mirrorlist?repo=fedora-42&arch=x86_64
repo --name=update --mirrorlist=http://mirrors.fedoraproject.org/mirrorlist?repo=updates-released-f42&arch=x86_64

#Keyboard layouts
keyboard --vckeymap=pl --xlayouts='pl' 
#System language
lang pl_PL.UTF-8

#Run the Setup Agent on first boot
firstboot --enable

#Generated using Blivet version 3.12.1
ignoredisk --only-use=sda

#Partition clearing information
clearpart --all --initlabel
autopart

#System timezone
timezone Europe/Warsaw --utc

#Root password
rootpw --allow-ssh root

user --groups=wheel --name=bartek --password=bartek

%packages
@core
@^server-product-environment
docker
wget 
curl
dnf
git
cmake
%end

%post --interpreter=/usr/bin/bash
exec > /root/post-install.log 2>&1

echo "Skrypt obsługujący dockera"

cat << 'EOF' > /usr/local/bin/start-docker-job.sh
#!/bin/bash
exec >> /var/log/docker-job.log 2>&1
echo "Uruchamianie skryptu"
systemctl start docker

cd /root
echo "Klonowanie repozytorium cJSON"
git clone https://github.com/Bartek449/cJSON.git

cd cJSON
echo "Budowanie obrazu buildera"
docker build -f Dockerfile.build -t lab02-build .

echo "Uruchamianie builda"
docker run --rm lab02-build

echo "Budowanie obrazu testera"
docker build -f Dockerfile.test -t lab02-test .

echo "Uruchamianie testera"
docker run --rm lab02-test

echo "Koniec skryptu"
EOF

chmod +x /usr/local/bin/start-docker-job.sh

echo "Tworzenie jednostki systemd..."
cat << 'EOF' > /etc/systemd/system/docker-setup.service

[Unit]
Description=Jednorazowa konfiguracja Dockera i kontenera
After=network-online.target docker.service
Wants=network-online.target docker.service

[Service]
Type=oneshot
ExecStart=/usr/local/bin/start-docker-job.sh
RemainAfterExit=yes

[Install]
WantedBy=multi-user.target
EOF

echo "Włączanie usług systemd..."
systemctl enable docker
systemctl enable docker-setup
%end

reboot
